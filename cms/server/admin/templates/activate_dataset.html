{% extends "base.html" %}

{% block js_init %}
setAllNotifyCheckboxes = function(state) {
    var boxes = $(".notify_user_box");
    for (i = 0; i < boxes.length; i++) {
        boxes[i].checked = state;
    }
};
setDefaultNotifyCheckboxes = function() {
    var boxes = $(".default_notify_on");
    for (i = 0; i < boxes.length; i++) {
        boxes[i].checked = true;
    }
    var boxes = $(".default_notify_off");
    for (i = 0; i < boxes.length; i++) {
        boxes[i].checked = false;
    }
};
setDefaultNotifyCheckboxes();
{% endblock js_init %}

{% block core %}
{% set current_score_type = none %}

<h1>Preview dataset change</h1>
<h2>{{ task.title }} (<a href="{{ url("task", task.id) }}">{{ task.name }}</a>)</h2>

<table>
  <tr>
    <td>Current dataset:</td>
    <td><strong class="ml-3">{{ task.active_dataset.description }}</strong></td>
    <td><a class="ml-3" href="{{ url("dataset", task.active_dataset_id) }}">[View results]</td>
  </tr>
  <tr>
    <td>New dataset:</td>
    <td><strong class="ml-3">{{ dataset.description }}</strong></td>
    <td><a class="ml-3" href="{{ url("dataset", dataset.id) }}">[View results]</td>
  </tr>
</table>

<p class="mt-4"><strong>NOTE</strong>: The preview on this page uses the existing scoring information
for both datasets. If you have made modifications to a dataset, you need to
ensure that the scores are up to date. This may require re-compiling,
re-evaluating or just re-scoring the entire dataset. To do so, use the buttons
below, and wait for it to complete.</p>

<p>
  Reevaluate all submissions for the dataset "{{ dataset.description }}":
  {{ ReevaluationButtons(
       url("dataset", dataset.id),
       dataset_id=dataset.id) }}
</p>

<form action="{{ url("dataset", dataset.id, "activate") }}" method="POST">
  {{ xsrf_form_html|safe }}
  {% if changes|length == 0 %}
    <p>Good news! At present, switching to this dataset will have no effect on the
      scores. No notifications will be sent.</p>
  {% else %}
    <p>Switching to this dataset will cause the following changes:</p>
    <table class="table table-sm">
      <thead>
        <tr>
          <th>Notify</th>
          <th>User</th>
          <th>Submission id</th>
          <th>Change</th>
        </tr>
      </thead>
      <tbody>
        {% for p, changes_by_participation in changes|groupby("submission.participation.id")|sort %}
          {% for c in changes_by_participation|sort(attribute="submission.id") %}
            <tr>
              <td style="text-align: center;">
                {% if loop.first %}
                  <input type="checkbox" class="notify_user_box default_notify_{{ "on" if c.submission.participation.id in default_notify_participations else "off" }}" name="notify_{{ c.submission.participation.id }}"/>
                {% endif %}
              </td>
              <td>
                {% if loop.first %}
                  <a href="{{ url("user", c.submission.participation.user.id) }}">{{ c.submission.participation.user.username }}</a>
                {% endif %}
              </td>
              <td><a href="{{ url("submission", c.submission.id) }}">{{ c.submission.id }}</a>{{ " (Tokened)" if c.submission.tokened() else "" }}</td>
              <td>
                {% if c.old_score is not none or c.new_score is not none %}
                  <strong>Score</strong>: {{ c.old_score }} &rightarrow; {{ c.new_score }}<br/>
                {% endif %}
                {% if c.old_public_score is not none or c.new_public_score is not none %}
                  <strong>Public score</strong>: {{ c.old_public_score }} &rightarrow; {{ c.new_public_score }}<br/>
                {% endif %}
                {% if c.old_ranking_score_details is not none or c.new_ranking_score_details is not none %}
                  <strong>Ranking score</strong>: <br/>
                  <code>{{ c.old_ranking_score_details|tojson|forceescape }}</code><br/>
                  <code>{{ c.new_ranking_score_details|tojson|forceescape }}</code><br/>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>

    <p>
      Notify:
      <a href="#" class="btn btn-sm btn-outline-primary" onclick="setAllNotifyCheckboxes(true);">All users</a>
      <a href="#" class="btn btn-sm btn-outline-primary" onclick="setAllNotifyCheckboxes(false);">No users</a>
      <a href="#" class="btn btn-sm btn-outline-primary" onclick="setDefaultNotifyCheckboxes();">Users with visible changes only</a>
    </p>

    <p>
      By default, users with changes to their public score, or changes to the score
      of a tokened submission, will be notified.
    </p>

    <p>
      The following message will be sent to the selected users:
    </p>

    <div class="form-group row">
      <label class="col-md-3 col-form-label">
        Subject
      </label>
      <div class="col-md-9">
        <input class="form-control" type="text" name="message_subject" value="Task {{ task.name }} has been rejudged">
      </div>
    </div>
    <div class="form-group row">
      <label class="col-md-3 col-form-label">
        Text
      </label>
      <div class="col-md-9">
        <textarea class="form-control" name="message_text">The task "{{ task.name }}" has been rejudged and the score on your submissions has been updated.</textarea>
      </div>
    </div>
  {% endif %}

  <p>
    <input class="btn btn-success" type="submit" value="Activate!"/>
    <input class="btn btn-warning" type="button" value="Abort!" onclick="javascript:history.back();"/>
  </p>
</form>

{% endblock core %}
