{% extends "base.html" %}

{% block js_init %}

function showTaskTypeOption(dataset_id) {
    var selector = $("select[name=task_type_" + dataset_id + "]")[0];
    $(".TaskTypeOptions_" + dataset_id + ":visible").hide("fast");
    $("#TaskType" + selector.options[selector.selectedIndex].value + "Options_" + dataset_id).show("fast")
};

{% for dataset in task.datasets %}
showTaskTypeOption({{ dataset.id }});
$("select[name=task_type_{{ dataset.id }}]").change(function() {
    showTaskTypeOption({{ dataset.id }});
});
{% endfor %}

{% endblock js_init %}

{% block core %}
{% set task_type_list = plugin_list("cms.grading.tasktypes", "tasktypes") %}
{% set score_type_list = plugin_list("cms.grading.scoretypes", "scoretypes") %}

<h1 class="display-4">{{ task.title }} ({{ task.name }})</h1>

<h2 class="mt-4">Submissions</h2>
<div id="submissions">
  {% if submissions|length == 0 %}
    <p>No submissions for this task yet.</p>
  {% else %}
    <a href="{{ url("dataset", task.active_dataset_id) }}">
      {% if submissions|length == 1 %}
        1 submission
      {% else %}
        {{ submissions|length }} submissions
      {% endif %}
    </a>
  {% endif %}
</div>

{# We use "multipart/form-data" to have Tornado distinguish between missing and empty values. #}
<form enctype="multipart/form-data" action="{{ url("task", task.id) }}" method="POST">
  {{ xsrf_form_html|safe }}

  <h2 class="mt-4">Task configuration</h2>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Name
        <span class="help-text">A short name for the task, preferably using only letters, numbers and underscores.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="name" value="{{ task.name }}">
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Title
        <span class="help-text">The title of the task as seen by the contestants.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="title" value="{{ task.title }}">
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Position
        <span class="help-text">The index of the task within the contest, if the task is associated with a contest.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control-plaintext" readonly type="text" value="{{ task.num }}">
    </div>
  </div>
  <div class="form-group row">
    <label class="col-md-3 col-form-label">
      <span class="help">
        Statements
        <span class="help-text">The statements of this task, by language code. Primary statements are shown prominently to contestants.</span>
      </span>
      {% if admin.permission_all %}
        <a class="btn btn-sm btn-outline-success" href="{{ url("task", task.id, "statements", "add") }}">Add</a>
      {% endif %}
    </label>
    <div class="col-md-9">
      {% if task.statements|length == 0 %}
        <span class="form-control-plaintext">No statements uploaded yet</span>
      {% else %}
        <table>
          <tbody>
            {% for statement in itervalues(task.statements) %}
              <tr>
                <td>
                  <a href="{{ url("file", statement.digest, "statement.pdf") }}">Statement for "{{ statement.language }}"</a>
                </td>
                <td class="pl-3">
                  <label>
                    <input type="checkbox" name="primary_statement_{{ statement.language }}" {% if statement.language in primary_statements %}checked{% endif %} />
                    Primary?
                  </label>
                </td>
                <td class="pl-3">
                  <a class="btn btn-outline-danger btn-sm" onclick="CMS.AWSUtils.ajax_delete('{{ url("task", task.id, "statement", statement.id) }}'); ">Delete</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div>
  </div>
  <div class="form-group row">
    <label class="col-md-3 col-form-label">
      <span class="help">
        Attachments
        <span class="help-text">Attachments for this task. Contestant can view and download attachments from the task page.</span>
      </span>
      {% if admin.permission_all %}
        <a class="btn btn-sm btn-outline-success" href="{{ url("task", task.id, "attachments", "add") }}">Add</a>
      {% endif %}
    </label>
    <div class="col-md-9">
      {% if task.attachments|length == 0 %}
        <span class="form-control-plaintext">No attachments uploaded yet</span>
      {% else %}
        <table>
          <tbody>
            {% for attachment in itervalues(task.attachments) %}
              <tr>
                <td>
                  <a href="{{ url("file", attachment.digest, attachment.filename) }}">{{ attachment.filename }}</a>
                </td>
                <td class="pl-3">
                  <a class="btn btn-outline-danger btn-sm" onclick="CMS.AWSUtils.ajax_delete('{{ url("task", task.id, "attachment", attachment.id) }}'); ">Delete</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Submission format
        <span class="help-text">A comma-separated list with the names of the files that need to be submitted (with the language extensions changed to %l).
                              The task type dictates the submission format. Consult the task type documentation to know the requirements.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="submission_format" value="{{ task.submission_format|join(", ") }}"/>
    </div>
  </div>


  <h2 class="mt-4">Tokens parameters (<a href="http://cms.readthedocs.org/en/{{ rtd_version }}/Configuring%20a%20contest.html#feedback-to-contestants" target="_blank">documentation</a>)</h2>

  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Token mode
        <span class="help-text">Select 'disabled' to remove tokens completely for this task, 'infinite' for allowing any number of tokens for this task, or 'finite' to specify the amount with the following parameters.
                              If you prefer to control tokens at the task level, select 'infinite' here.</span>
      </span>
    </label>
    <div class="col-md-9">
      <select name="token_mode" class="form-control">
        <option value="disabled" {{ "selected" if task.token_mode == "disabled" else "" }}>Disabled</option>
        <option value="finite" {{ "selected" if task.token_mode == "finite" else "" }}>Finite</option>
        <option value="infinite" {{ "selected" if task.token_mode == "infinite" else "" }}>Infinite</option>
      </select>
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Maximum number of tokens
        <span class="help-text">The maximum number of tokens a contestant can use in this task.
                              It is used only if tokens are finite.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="token_max_number" value="{{ task.token_max_number if task.token_max_number is not none else "" }}" />
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Minimum interval between tokens
        <span class="help-text">The minimum amount of time (in seconds) that a contestant needs to wait for this task after using a token before being able to use another.
                              It is used only if tokens are finite.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="token_min_interval" value="{{ task.token_min_interval.total_seconds()|int }}" />
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Initial number of tokens
        <span class="help-text">The number of tokens that a contestant has available for this task when their contest time starts.
                              It is used only if tokens are finite.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="token_gen_initial" value="{{ task.token_gen_initial }}" />
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Token generation number
        <span class="help-text">The number of tokens that are generated periodically for this task.
                              It is used only if tokens are finite.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="token_gen_number" value="{{ task.token_gen_number }}" />
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Token generation period
        <span class="help-text">The amount of time (in minutes) between two token generation events for this task.
                              It is used only if tokens are finite.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="token_gen_interval" value="{{ task.token_gen_interval.total_seconds()|int // 60 }}" />
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Maximum accumulated tokens
        <span class="help-text">Maximum number of tokens for this task available to a contestant at any given time during the contest.
                              It is used only if tokens are finite.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="token_gen_max" value="{{ task.token_gen_max if task.token_gen_max is not none else "" }}" />
    </div>
  </div>


  <h2>Limits</h2>

  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Maximum number of submissions
        <span class="help-text">Maximum number of submissions each contestant can submit for this task, for the whole contest.
                              Leave empty for no limits.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="max_submission_number" value="{{ task.max_submission_number if task.max_submission_number is not none else "" }}">
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Maximum number of user tests
        <span class="help-text">Maximum number of user tests each contestant can submit for this task, for the whole contest.
                              Leave empty for no limits.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="max_user_test_number" value="{{ task.max_user_test_number if task.max_user_test_number is not none else "" }}">
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Minimum interval between submissions
        <span class="help-text">The minimum amount of time (in seconds) for this task that a contestant needs to wait after a submission before being able to submit another.
                              Leave empty for no limits.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="min_submission_interval" value="{{ task.min_submission_interval.total_seconds()|int if task.min_submission_interval is not none else "" }}">
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Minimum interval between user tests
        <span class="help-text">The minimum amount of time (in seconds) for this task that a contestant needs to wait after a user test before being able to send another.
                              Leave empty for no limits.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="min_user_test_interval" value="{{ task.min_user_test_interval.total_seconds()|int if task.min_user_test_interval is not none else "" }}">
    </div>
  </div>


  <h2 class="mt-4">Score options</h2>

  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Score decimal places
        <span class="help-text">The number of decimal places the scores will be rounded to.
                              Example: '2' to allow 98.76.</span>
      </span>
    </label>
    <div class="col-md-9">
      <input class="form-control" type="text" name="score_precision" value="{{ task.score_precision }}">
    </div>
  </div>
  <div class="form-group row">
   <label class="col-md-3 col-form-label">
      <span class="help">
        Score mode
        <span class="help-text">How the score for the task is computed from the score of each submission.</span>
      </span>
    </label>
    <div class="col-md-9">
      <select name="score_mode" class="form-control">
        <option value="{{ SCORE_MODE_MAX_TOKENED_LAST }}" {{ "selected" if task.score_mode == SCORE_MODE_MAX_TOKENED_LAST else "" }}>Use best among tokened and last submissions (IOI 2010-2012)</option>
        <option value="{{ SCORE_MODE_MAX }}" {{ "selected" if task.score_mode == SCORE_MODE_MAX else "" }}>Use best among all submissions (IOI 2013-)</option>
      </select>
    </div>
  </div>

  <h2 class="mt-4">Datasets</h2>
  <div id="datasets">
    <p>
      {% if task.datasets|length == 0 %}
        No datasets have been created for this task.<br/>
      {% endif %}
      {% if admin.permission_all %}
        <a href="{{ url("task", task.id, "add_dataset") }}">Create a new dataset</a><br/>
      {% endif %}
    </p>

    {% for dataset in task.datasets|sort(attribute="description") %}
      <h3>Dataset: {{ dataset.description }} <small>{{ dataset|format_dataset_attrs }}</small></h3>
      <div class="task_dataset">
        <p>
          {% if admin.permission_all %}
            {% if dataset is sameas (task.active_dataset) %}
              <a class="btn btn-outline-primary btn-sm disabled">Make Live...</a>
            {% else %}
              <a class="btn btn-outline-primary btn-sm" href="{{ url("dataset", dataset.id, "activate") }}">Make Live...</a>
            {% endif %}
            <a class="btn btn-outline-primary btn-sm" href="{{ url("dataset", dataset.id, "clone") }}">Clone</a>
            <a class="btn btn-outline-primary btn-sm" href="{{ url("dataset", dataset.id, "rename") }}">Rename</a>
            {% if dataset is sameas (task.active_dataset) %}
              <a class="btn btn-outline-danger btn-sm disabled">Delete</a>
            {% else %}
              <a class="btn btn-outline-danger btn-sm" href="{{ url("dataset", dataset.id, "delete") }}">Delete</a>
            {% endif %}
            {% if dataset is not sameas (task.active_dataset) %}
              <a class="btn btn-outline-primary btn-sm" onclick="CMS.AWSUtils.ajax_post('{{ url("dataset", dataset.id, "autojudge") }}');" href="#">
                {% if dataset.autojudge %}Disable{% else %}Enable{% endif %}
                background judging
              </a>
            {% endif %}
          {% endif %}
          <a class="btn btn-outline-primary btn-sm" href="{{ url("dataset", dataset.id) }}">View results</a>
        </p>

        {% if dataset.task_type not in task_type_list|map(attribute="__name__")|list %}
          <script type="text/javascript">
            $(document).ready(function() {
              utils.display_notification("notification",
                0,
                "Task type `{{ dataset.task_type }}' not found.",
                "Please select another task type, " +
                "or make the original one available and refresh the page " +
                "without updating the task to avoid losing the parameters.");
            });
          </script>
        {% endif %}

        {% if dataset.score_type not in score_type_list|map(attribute="__name__")|list %}
          <script type="text/javascript">
            $(document).ready(function() {
              utils.display_notification("notification",
                0,
                "Score type `{{ dataset.score_type }}' not found.",
                "Please select another score type, " +
                "or make the original one available and refresh the page " +
                "without updating the task to avoid losing the parameters.");
            });
          </script>
        {% endif %}

        <div class="form-group row">
         <label class="col-md-3 col-form-label">
      <span class="help">
        Time limit (seconds)
        <span class="help-text">Total maximum time for each evaluation, in seconds.</span>
      </span>
    </label>
          <div class="col-md-9">
            <input class="form-control" type="text" name="time_limit_{{ dataset.id }}" value="{{ dataset.time_limit if dataset.time_limit is not none else "" }}"/>
          </div>
        </div>
        <div class="form-group row">
         <label class="col-md-3 col-form-label">
      <span class="help">
        Memory limit (MiB)
        <span class="help-text">Total maximum memory usage for each evaluation, in MiB (2^20 bytes).</span>
      </span>
    </label>
          <div class="col-md-9">
            <input class="form-control" type="text" name="memory_limit_{{ dataset.id }}" value="{{ dataset.memory_limit if dataset.memory_limit is not none else "" }}"/>
          </div>
        </div>


        <h4 class="mt-4">Task type settings (<a href="http://cms.readthedocs.org/en/{{ rtd_version }}/Task%20types.html" target="_blank">documentation</a>)</h4>

        <div class="form-group row">
         <label class="col-md-3 col-form-label">
      <span class="help">
        Task type
        <span class="help-text">Please see the task type documentation.</span>
      </span>
    </label>
          <div class="col-md-9">
            <select class="form-control" name="task_type_{{ dataset.id }}">
              {% for task_type in task_type_list %}
                <option value="{{ task_type.__name__ }}" {% if dataset.task_type == task_type.__name__ %}selected{% endif %}>{{ task_type.__name__ }}</option>
              {% endfor %}
            </select>
            {% set parameters = dataset.task_type_parameters %}
            {% for task_type in task_type_list %}
              <table class="TaskTypeOptions TaskTypeOptions_{{ dataset.id }} table table-sm table-borderless mt-3" id="TaskType{{ task_type.__name__ }}Options_{{ dataset.id }}" style="display: none;">
                {% for i in range(task_type.ACCEPTED_PARAMETERS|length) %}
                  {% set param_def = task_type.ACCEPTED_PARAMETERS[i] %}
                  {% set parameter_value = parameters[i] if dataset.task_type == task_type.__name__ and parameters is not none and i < parameters|length else none %}
                  <tr>
                    <td class="col-form-label">{{ param_def.name }}</td>
                    <td>
                      {{ param_def.render("TaskTypeOptions_%d_%s_"|format(dataset.id, task_type.__name__), parameter_value)|safe }}
                    </td>
                  </tr>
                {% endfor %}
              </table>
            {% endfor %}
          </div>
        </div>
        <div class="form-group row">
          <label class="col-md-3 col-form-label">
            <span class="help">
              Managers
              <span class="help-text">Managers for this task. Managers are sources, headers, libraries or binaries used during the evaluation.</span>
            </span>
            {% if admin.permission_all %}
              <a class="btn btn-sm btn-outline-success" href="{{ url("dataset", dataset.id, "managers", "add") }}">Add</a>
            {% endif %}
          </label>
          <div class="col-md-9">
            {% if dataset.managers|length == 0 %}
              <span class="form-control-plaintext">No managers uploaded yet</span>
            {% else %}
              <table>
                <tbody>
                  {% for manager in itervalues(dataset.managers) %}
                    <tr>
                      <td>
                        <a href="{{ url("file", manager.digest, manager.filename) }}">{{ manager.filename }}</a>
                      </td>
                      <td class="pl-3">
                        <a class="btn btn-outline-danger btn-sm" onclick="CMS.AWSUtils.ajax_delete('{{ url("dataset", dataset.id, "manager", manager.id, "delete") }}');">Delete</a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% endif %}
          </div>
        </div>


        <h4 class="mt-4">Score type settings (<a href="http://cms.readthedocs.org/en/{{ rtd_version }}/Score%20types.html" target="_blank">documentation</a>)</h4>

        <div class="form-group row">
         <label class="col-md-3 col-form-label">
      <span class="help">
        Score Type
        <span class="help-text">Please see the score type documentation.</span>
      </span>
    </label>
          <div class="col-md-9">
            <select name="score_type_{{ dataset.id }}" class="form-control">
              {% for score_type in score_type_list %}
                <option value="{{ score_type.__name__}}" {% if dataset.score_type == score_type.__name__ %}selected{% endif %}>{{ score_type.__name__ }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="form-group row">
         <label class="col-md-3 col-form-label">
      <span class="help">
        Score Parameters
        <span class="help-text">Please see the score type documentation.</span>
      </span>
    </label>
          <div class="col-md-9">
            <textarea class="form-control" name="score_type_parameters_{{ dataset.id }}">{{ dataset.score_type_parameters|tojson|forceescape }}</textarea>
          </div>
        </div>


        <h4 class="mt-4">Test cases</h4>

        {% if admin.permission_all %}
          <a class="btn btn-outline-primary btn-sm" href="{{ url("dataset", dataset.id, "testcases", "add") }}">Add a testcase</a>
          <a class="btn btn-outline-primary btn-sm" href="{{ url("dataset", dataset.id, "testcases", "add_multiple") }}">Add multiple testcases</a>
        {% endif %}
        <a class="btn btn-outline-primary btn-sm" href="{{ url("dataset", dataset.id, "testcases", "download") }}">Download all testcases</a>

        <table class="table table-sm mt-3">
          <thead>
            <tr>
              <th>#</th>
              <th>Codename</th>
              <th>Public</th>
              <th>Input</th>
              <th>Output</th>
              <th>Ops</th>
            </tr>
          </thead>
          <tbody>
            {% for codename, testcase in dataset.testcases|dictsort(by="key") %}
              <tr>
                <td class="align-middle"><strong>{{ loop.index }}</strong></td>
                <td class="align-middle">{{ codename }}</td>
                <td class="align-middle">
                  <input type="checkbox" name="testcase_{{ testcase.id }}_public" {% if testcase.public %}checked{% endif %} />
                </td>
                <td class="align-middle">
                  <a href="javascript:void(0);" onclick="utils.show_file('input_{{ testcase.codename }}','{{ url("file", testcase.input, "input_%s"|format(testcase.codename)) }}')">Show input</a>
                </td>
                <td class="align-middle">
                  <a href="javascript:void(0);" onclick="utils.show_file('output_{{ testcase.codename }}','{{ url("file", testcase.output, "output_%s"|format(testcase.codename)) }}')">Show output</a>
                </td>
                <td>
                  <a class="btn btn-sm btn-outline-danger" onclick="CMS.AWSUtils.ajax_delete('{{ url("dataset", dataset.id, "testcase", testcase.id, "delete") }}');">Delete</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <hr />
    {% endfor %}
  </div>
  <input type="submit"
         class="btn btn-success mb-4"
         {% if not admin.permission_all %}
           disabled
         {% endif %}
         value="Update" />
  <input type="reset" value="Reset" class="btn btn-warning mb-4" />
</form>
<form action="{{ url("tasks") }}" method="POST">
    {{ xsrf_form_html|safe }}
    <input type="hidden" name="task_id" value="{{ task.id }}"/>
    <input type="submit"
         name="operation"
         value="Remove"
         class="btn btn-danger mb-4"
         {% if not admin.permission_all %}
           disabled
         {% endif %}
         />
</form>
{% endblock core %}
